language: node_js

node_js:
  - "lts/*"

cache:
  directories:
    - node_modules

services:
  - docker

env:
  global:
    - tf_version=0.12.29
    - TF_VAR_container_tag=$TRAVIS_BUILD_NUMBER
    - TF_VAR_gcloud_credentials=$gcloud_service_account

# Install dependencies
before_install:
  - wget https://releases.hashicorp.com/terraform/"$tf_version"/terraform_"$tf_version"_linux_amd64.zip
  - unzip terraform_"$tf_version"_linux_amd64.zip
  - sudo mv terraform /usr/local/bin/
  - rm terraform_"$tf_version"_linux_amd64.zip

jobs:
  include:
    - stage: test
      script:
        - yarn test
    - stage: build and push
        - yarn run build
        - docker build -t asia.gcr.io/youngjosh-personal-site/youngjosh-personal-site-fe:$TRAVIS_BUILD_NUMBER ./
        - docker push asia.gcr.io/youngjosh-personal-site/youngjosh-personal-site-fe:$TRAVIS_BUILD_NUMBER
    - stage: terraform deploy
      # Only run terraform apply on merge to master
      if: type IN (push) and branch = master
      script:
        - echo "Executing Terraform Apply on merged code"
        - terraform init -input=false
        - terraform import google_cloud_run_service.personal_site_frontend asia-east1/youngjosh-personal-site-fe
        - terraform apply -auto-approve -input=false
